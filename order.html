<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单确认 - 快点点餐厅</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- 顶部导航 -->
        <header class="header">
            <button class="back-btn" onclick="window.location.href='menu.html'">
                ← 返回首页
            </button>
            <h1>订单确认</h1>
        </header>

        <!-- 订单内容 -->
        <main class="order-main">
            <!-- 加载状态 -->
            <div id="loading" class="loading">
                加载订单信息...
            </div>

            <!-- 订单详情 -->
            <div id="orderDetails" class="order-details" style="display: none;">
                <!-- 订单基本信息 -->
                <div class="order-section">
                    <h3>订单信息</h3>
                    <div class="order-info-grid">
                        <div class="info-item">
                            <span class="label">订单号：</span>
                            <span id="orderNo" class="value"></span>
                        </div>
                        <div class="info-item">
                            <span class="label">下单时间：</span>
                            <span id="orderTime" class="value"></span>
                        </div>
                        <div class="info-item">
                            <span class="label">点餐类型：</span>
                            <span id="orderType" class="value"></span>
                        </div>
                        <div class="info-item" id="tableNoItem">
                            <span class="label">桌号：</span>
                            <span id="tableNo" class="value"></span>
                        </div>
                        <div class="info-item" id="addressItem" style="display: none;">
                            <span class="label">配送地址：</span>
                            <span id="address" class="value"></span>
                        </div>
                        <div class="info-item" id="phoneItem" style="display: none;">
                            <span class="label">联系电话：</span>
                            <span id="phone" class="value"></span>
                        </div>
                    </div>
                </div>

                <!-- 菜品清单 -->
                <div class="order-section">
                    <h3>菜品清单</h3>
                    <div id="orderItemsList" class="order-items-list">
                        <!-- 菜品项将通过JS动态生成 -->
                    </div>
                </div>

                <!-- 金额汇总 -->
                <div class="order-section">
                    <div class="price-summary">
                        <div class="price-row total">
                            <span>订单总金额：</span>
                            <span id="totalAmount">¥0.00</span>
                        </div>
                    </div>
                </div>

                <!-- 支付状态 -->
                <div class="order-section">
                    <h3>支付状态</h3>
                    <div class="payment-status">
                        <div id="paymentStatus" class="status-pending">待支付</div>
                        <button id="payButton" class="pay-btn" onclick="simulatePayment()">
                            模拟支付
                        </button>
                        <div id="paymentSuccess" class="status-success" style="display: none;">
                            ✅ 支付成功！后厨已开始制作，请稍候...
                        </div>
                    </div>
                </div>

                <!-- 订单状态说明 -->
                <div class="order-section">
                    <div class="order-status-info">
                        <h4>订单状态说明</h4>
                        <div class="status-timeline">
                            <div class="timeline-item active" id="statusPending">
                                <div class="timeline-dot"></div>
                                <div class="timeline-content">
                                    <strong>待支付</strong>
                                    <p>订单已提交，等待支付确认</p>
                                </div>
                            </div>
                            <div class="timeline-item" id="statusPaid">
                                <div class="timeline-dot"></div>
                                <div class="timeline-content">
                                    <strong>已支付</strong>
                                    <p>支付完成，后厨开始制作</p>
                                </div>
                            </div>
                            <div class="timeline-item" id="statusCompleted">
                                <div class="timeline-dot"></div>
                                <div class="timeline-content">
                                    <strong>已完成</strong>
                                    <p>菜品制作完成，可前来取餐</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 订单不存在 -->
            <div id="orderNotFound" class="order-not-found" style="display: none;">
                <div class="not-found-icon">❌</div>
                <h3>订单不存在</h3>
                <p>请检查订单号是否正确</p>
                <button class="primary-btn" onclick="window.location.href='menu.html'">
                    返回首页
                </button>
            </div>
        </main>
    </div>

    <script src="supabase-config.js"></script>
    <script>
        // 页面加载时获取订单信息
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const orderNo = urlParams.get('order_no');
            
            if (orderNo) {
                loadOrderDetails(orderNo);
            } else {
                showOrderNotFound();
            }
        });

        // 加载订单详情
        async function loadOrderDetails(orderNo) {
            try {
                // 查询订单主信息
                const { data: orderData, error: orderError } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('order_no', orderNo)
                    .single();

                if (orderError) throw orderError;
                if (!orderData) {
                    showOrderNotFound();
                    return;
                }

                // 查询订单项信息
                const { data: itemsData, error: itemsError } = await supabase
                    .from('order_items')
                    .select(`
                        *,
                        dishes (name, image_url)
                    `)
                    .eq('order_id', orderData.id);

                if (itemsError) throw itemsError;

                // 显示订单详情
                displayOrderDetails(orderData, itemsData);

            } catch (error) {
                console.error('加载订单失败:', error);
                showOrderNotFound();
            }
        }

        // 显示订单详情
        function displayOrderDetails(order, items) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('orderDetails').style.display = 'block';

            // 设置订单基本信息
            document.getElementById('orderNo').textContent = order.order_no;
            document.getElementById('orderTime').textContent = formatDateTime(order.created_at);
            
            const orderTypeText = order.type === 'dine_in' ? '堂食' : '外卖';
            document.getElementById('orderType').textContent = orderTypeText;

            // 设置桌号或地址信息
            if (order.type === 'dine_in') {
                document.getElementById('tableNoItem').style.display = 'block';
                document.getElementById('tableNo').textContent = order.table_no;
                document.getElementById('addressItem').style.display = 'none';
                document.getElementById('phoneItem').style.display = 'none';
            } else {
                document.getElementById('tableNoItem').style.display = 'none';
                document.getElementById('addressItem').style.display = 'block';
                document.getElementById('phoneItem').style.display = 'block';
                document.getElementById('address').textContent = order.address;
                document.getElementById('phone').textContent = order.phone || '未填写';
            }

            // 设置金额
            document.getElementById('totalAmount').textContent = `¥${order.total_amount.toFixed(2)}`;

            // 设置菜品列表
            displayOrderItems(items);

            // 设置支付状态
            updatePaymentStatus(order.status);
        }

        // 显示订单菜品
        function displayOrderItems(items) {
            const itemsList = document.getElementById('orderItemsList');
            itemsList.innerHTML = '';

            items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'order-item';
                itemElement.innerHTML = `
                    <div class="item-info">
                        <h4>${item.dishes.name}</h4>
                        <p class="item-quantity">数量：${item.quantity}</p>
                    </div>
                    <div class="item-price">
                        ¥${(item.unit_price * item.quantity).toFixed(2)}
                    </div>
                `;
                itemsList.appendChild(itemElement);
            });
        }

        // 更新支付状态
        function updatePaymentStatus(status) {
            const paymentStatus = document.getElementById('paymentStatus');
            const payButton = document.getElementById('payButton');
            const paymentSuccess = document.getElementById('paymentSuccess');

            if (status === 'paid') {
                paymentStatus.textContent = '已支付';
                paymentStatus.className = 'status-success';
                payButton.style.display = 'none';
                paymentSuccess.style.display = 'block';
                
                // 更新状态时间线
                document.getElementById('statusPending').classList.remove('active');
                document.getElementById('statusPaid').classList.add('active');
            } else {
                paymentStatus.textContent = '待支付';
                paymentStatus.className = 'status-pending';
                payButton.style.display = 'block';
                paymentSuccess.style.display = 'none';
            }
        }

        // 模拟支付
        async function simulatePayment() {
            const orderNo = document.getElementById('orderNo').textContent;
            
            // 显示加载中
            document.getElementById('payButton').textContent = '支付中...';
            document.getElementById('payButton').disabled = true;

            try {
                // 模拟支付延迟
                await new Promise(resolve => setTimeout(resolve, 2000));

                // 更新订单状态
                const { error } = await supabase
                    .from('orders')
                    .update({ status: 'paid' })
                    .eq('order_no', orderNo);

                if (error) throw error;

                // 更新UI
                updatePaymentStatus('paid');

            } catch (error) {
                console.error('支付失败:', error);
                alert('支付失败，请重试');
                document.getElementById('payButton').textContent = '模拟支付';
                document.getElementById('payButton').disabled = false;
            }
        }

        // 显示订单不存在
        function showOrderNotFound() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('orderDetails').style.display = 'none';
            document.getElementById('orderNotFound').style.display = 'block';
        }

        // 格式化日期时间
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
    </script>
</body>
</html>