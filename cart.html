<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´­ç‰©è½¦ - å¿«ç‚¹ç‚¹é¤å…</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="header">
            <button class="back-btn" onclick="window.location.href='menu.html'">
                â† è¿”å›èœå•
            </button>
            <h1>è´­ç‰©è½¦</h1>
            <div class="cart-count" id="headerCartCount">0</div>
        </header>

        <!-- è´­ç‰©è½¦å†…å®¹ -->
        <main class="cart-main">
            <!-- è´­ç‰©è½¦ä¸ºç©ºçŠ¶æ€ -->
            <div id="emptyCart" class="empty-cart">
                <div class="empty-icon">ğŸ›’</div>
                <h3>è´­ç‰©è½¦ä¸ºç©º</h3>
                <p>å¿«å»èœå•é¡µé¢æŒ‘é€‰ç¾é£Ÿå§ï¼</p>
                <button class="primary-btn" onclick="window.location.href='menu.html'">
                    å»ç‚¹é¤
                </button>
            </div>

            <!-- è´­ç‰©è½¦å•†å“åˆ—è¡¨ -->
            <div id="cartItems" class="cart-items" style="display: none;">
                <div class="cart-section">
                    <h3>å·²é€‰èœå“</h3>
                    <div id="cartItemsList" class="items-list">
                        <!-- è´­ç‰©è½¦å•†å“é¡¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- ç‚¹é¤ç±»å‹é€‰æ‹© -->
                <div class="cart-section">
                    <h3>ç‚¹é¤ç±»å‹</h3>
                    <div class="order-type-selector">
                        <label class="order-type-option">
                            <input type="radio" name="orderType" value="dine_in" checked>
                            <span class="radio-custom"></span>
                            å ‚é£Ÿ
                        </label>
                        <label class="order-type-option">
                            <input type="radio" name="orderType" value="takeaway">
                            <span class="radio-custom"></span>
                            å¤–å–
                        </label>
                    </div>

                    <!-- å ‚é£Ÿä¿¡æ¯ -->
                    <div id="dineInInfo" class="order-info">
                        <label for="tableNo">æ¡Œå·ï¼š</label>
                        <input type="text" id="tableNo" placeholder="è¯·è¾“å…¥æ¡Œå·" required>
                    </div>

                    <!-- å¤–å–ä¿¡æ¯ -->
                    <div id="takeawayInfo" class="order-info" style="display: none;">
                        <label for="address">é…é€åœ°å€ï¼š</label>
                        <textarea id="address" placeholder="è¯·è¾“å…¥è¯¦ç»†é…é€åœ°å€" required></textarea>
                        <label for="phone">è”ç³»ç”µè¯ï¼š</label>
                        <input type="tel" id="phone" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯">
                    </div>
                </div>

                <!-- ä»·æ ¼æ±‡æ€» -->
                <div class="cart-section">
                    <div class="price-summary">
                        <div class="price-row">
                            <span>èœå“é‡‘é¢ï¼š</span>
                            <span id="subtotal">Â¥0.00</span>
                        </div>
                        <div class="price-row total">
                            <span>åˆè®¡ï¼š</span>
                            <span id="totalAmount">Â¥0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- åº•éƒ¨ç»“ç®—æŒ‰é’® -->
        <footer class="footer" id="cartFooter" style="display: none;">
            <button class="submit-order-btn" onclick="submitOrder()">
                æäº¤è®¢å•
            </button>
        </footer>
    </div>

    <!-- åŠ è½½æç¤º -->
    <div id="loading" class="loading" style="display: none;">
        å¤„ç†ä¸­...
    </div>

    <script src="supabase-config.js"></script>
    <script>
        // è´­ç‰©è½¦æ•°æ®
        let cartItems = [];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadCart();
            setupOrderTypeChange();
            updateCartDisplay();
        });

        // åŠ è½½è´­ç‰©è½¦æ•°æ®
        function loadCart() {
            const cartData = localStorage.getItem('kuai_dian_dian_cart');
            if (cartData) {
                cartItems = JSON.parse(cartData);
                updateCartDisplay();
            }
        }

        // è®¾ç½®ç‚¹é¤ç±»å‹å˜åŒ–ç›‘å¬
        function setupOrderTypeChange() {
            const radioButtons = document.querySelectorAll('input[name="orderType"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    const isTakeaway = this.value === 'takeaway';
                    document.getElementById('dineInInfo').style.display = isTakeaway ? 'none' : 'block';
                    document.getElementById('takeawayInfo').style.display = isTakeaway ? 'block' : 'none';
                });
            });
        }

        // æ›´æ–°è´­ç‰©è½¦æ˜¾ç¤º
        function updateCartDisplay() {
            const emptyCart = document.getElementById('emptyCart');
            const cartItemsDiv = document.getElementById('cartItems');
            const cartFooter = document.getElementById('cartFooter');
            const headerCartCount = document.getElementById('headerCartCount');

            if (cartItems.length === 0) {
                emptyCart.style.display = 'block';
                cartItemsDiv.style.display = 'none';
                cartFooter.style.display = 'none';
                headerCartCount.textContent = '0';
            } else {
                emptyCart.style.display = 'none';
                cartItemsDiv.style.display = 'block';
                cartFooter.style.display = 'flex';
                headerCartCount.textContent = cartItems.length;
                
                renderCartItems();
                calculateTotal();
            }
        }

        // æ¸²æŸ“è´­ç‰©è½¦å•†å“åˆ—è¡¨
        function renderCartItems() {
            const cartItemsList = document.getElementById('cartItemsList');
            cartItemsList.innerHTML = '';

            cartItems.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'cart-item';
                itemElement.innerHTML = `
                    <div class="item-info">
                        <h4>${item.name}</h4>
                        <p class="item-price">Â¥${item.price}</p>
                    </div>
                    <div class="item-controls">
                        <button class="qty-btn" onclick="updateQuantity(${index}, -1)">-</button>
                        <span class="item-qty">${item.quantity}</span>
                        <button class="qty-btn" onclick="updateQuantity(${index}, 1)">+</button>
                        <button class="delete-btn" onclick="removeItem(${index})">Ã—</button>
                    </div>
                `;
                cartItemsList.appendChild(itemElement);
            });
        }

        // æ›´æ–°å•†å“æ•°é‡
        function updateQuantity(index, change) {
            const newQuantity = cartItems[index].quantity + change;
            if (newQuantity > 0) {
                cartItems[index].quantity = newQuantity;
                saveCart();
                updateCartDisplay();
            }
        }

        // åˆ é™¤å•†å“
        function removeItem(index) {
            cartItems.splice(index, 1);
            saveCart();
            updateCartDisplay();
        }

        // ä¿å­˜è´­ç‰©è½¦åˆ°æœ¬åœ°å­˜å‚¨
        function saveCart() {
            localStorage.setItem('kuai_dian_dian_cart', JSON.stringify(cartItems));
        }

        // è®¡ç®—æ€»ä»·
        function calculateTotal() {
            const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('subtotal').textContent = `Â¥${subtotal.toFixed(2)}`;
            document.getElementById('totalAmount').textContent = `Â¥${subtotal.toFixed(2)}`;
        }

        // æäº¤è®¢å•
        async function submitOrder() {
            if (cartItems.length === 0) {
                alert('è´­ç‰©è½¦ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ å•†å“');
                return;
            }

            const orderType = document.querySelector('input[name="orderType"]:checked').value;
            let tableNo = '';
            let address = '';
            let phone = '';

            if (orderType === 'dine_in') {
                tableNo = document.getElementById('tableNo').value.trim();
                if (!tableNo) {
                    alert('è¯·è¾“å…¥æ¡Œå·');
                    return;
                }
            } else {
                address = document.getElementById('address').value.trim();
                phone = document.getElementById('phone').value.trim();
                if (!address) {
                    alert('è¯·è¾“å…¥é…é€åœ°å€');
                    return;
                }
            }

            // æ˜¾ç¤ºåŠ è½½ä¸­
            document.getElementById('loading').style.display = 'flex';

            try {
                // ç”Ÿæˆè®¢å•å·
                const orderNo = 'ORD' + new Date().getTime() + Math.random().toString(36).substr(2, 5).toUpperCase();
                
                // è®¡ç®—æ€»é‡‘é¢
                const totalAmount = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                // æ’å…¥è®¢å•åˆ°æ•°æ®åº“
                const { data: orderData, error: orderError } = await supabase
                    .from('orders')
                    .insert([{
                        order_no: orderNo,
                        type: orderType,
                        table_no: tableNo,
                        address: address,
                        phone: phone,
                        total_amount: totalAmount,
                        status: 'pending'
                    }])
                    .select();

                if (orderError) throw orderError;

                const orderId = orderData[0].id;

                // æ’å…¥è®¢å•é¡¹
                const orderItems = cartItems.map(item => ({
                    order_id: orderId,
                    dish_id: item.id,
                    quantity: item.quantity,
                    unit_price: item.price
                }));

                const { error: itemsError } = await supabase
                    .from('order_items')
                    .insert(orderItems);

                if (itemsError) throw itemsError;

                // æ¸…ç©ºè´­ç‰©è½¦
                localStorage.removeItem('kuai_dian_dian_cart');
                
                // è·³è½¬åˆ°è®¢å•ç¡®è®¤é¡µé¢
                window.location.href = `order.html?order_no=${orderNo}`;

            } catch (error) {
                console.error('æäº¤è®¢å•å¤±è´¥:', error);
                alert('æäº¤è®¢å•å¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
    </script>
</body>
</html>