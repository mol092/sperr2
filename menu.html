<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>快点点 - 菜单</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <header class="header">
            <button class="back-btn" onclick="window.location.href='index.html'">←</button>
            <h1>菜单</h1>
            <div class="cart-count" id="cartCount">0</div>
        </header>

        <!-- 主内容区域 -->
        <main class="main-content">
            <!-- 分类导航 -->
            <nav class="category-nav">
                <button class="category-btn active" data-category="all">全部</button>
                <!-- 分类按钮将通过JavaScript动态生成 -->
            </nav>

            <!-- 菜品列表 -->
            <section id="dishesSection">
                <div class="loading">加载中...</div>
                <div class="dishes-grid" id="dishesGrid" style="display: none;">
                    <!-- 菜品卡片将通过JavaScript动态生成 -->
                </div>
            </section>
        </main>

        <!-- 底部结算按钮 -->
        <footer class="footer">
            <button class="checkout-btn" onclick="goToCart()" id="checkoutBtn" disabled>
                去结算 (<span id="itemCount">0</span>)
            </button>
        </footer>
    </div>

    <!-- 引入Supabase配置 -->
    <script src="supabase-config.js"></script>
    
    <script>
        let currentCategory = 'all';
        let categories = [];
        let dishes = [];
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async function() {
            await loadCategories();
            await loadDishes();
            updateCartUI();
        });
        
        // 加载分类
        async function loadCategories() {
            try {
                const result = await window.kuaidiandianService.getCategories();
                if (result.success) {
                    categories = result.data;
                    renderCategories();
                } else {
                    showError('加载分类失败: ' + result.error);
                }
            } catch (error) {
                showError('加载分类失败: ' + error.message);
            }
        }
        
        // 渲染分类
        function renderCategories() {
            const categoryNav = document.querySelector('.category-nav');
            
            // 清空除"全部"按钮外的其他按钮
            const allBtn = categoryNav.querySelector('[data-category="all"]');
            categoryNav.innerHTML = '';
            categoryNav.appendChild(allBtn);
            
            // 添加分类按钮
            categories.forEach(category => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.textContent = category.name;
                btn.setAttribute('data-category', category.id);
                btn.addEventListener('click', () => selectCategory(category.id));
                categoryNav.appendChild(btn);
            });
        }
        
        // 选择分类
        function selectCategory(categoryId) {
            currentCategory = categoryId;
            
            // 更新按钮状态
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-category') === categoryId) {
                    btn.classList.add('active');
                }
            });
            
            // 筛选菜品
            filterDishes();
        }
        
        // 加载菜品
        async function loadDishes() {
            try {
                const result = await window.kuaidiandianService.getDishes();
                if (result.success) {
                    dishes = result.data;
                    renderDishes();
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('dishesGrid').style.display = 'grid';
                } else {
                    showError('加载菜品失败: ' + result.error);
                }
            } catch (error) {
                showError('加载菜品失败: ' + error.message);
            }
        }
        
        // 筛选菜品
        function filterDishes() {
            const filteredDishes = currentCategory === 'all' 
                ? dishes 
                : dishes.filter(dish => dish.category_id === currentCategory);
            
            renderDishes(filteredDishes);
        }
        
        // 渲染菜品
        function renderDishes(dishesToRender = dishes) {
            const dishesGrid = document.getElementById('dishesGrid');
            dishesGrid.innerHTML = '';
            
            dishesToRender.forEach(dish => {
                const dishCard = createDishCard(dish);
                dishesGrid.appendChild(dishCard);
            });
        }
        
        // 创建菜品卡片
        function createDishCard(dish) {
            const card = document.createElement('div');
            card.className = 'dish-card';
            
            card.innerHTML = `
                <div class="dish-image">
                    <img src="${dish.image_url || 'https://via.placeholder.com/150x150?text=菜品图片'}" alt="${dish.name}" onerror="this.src='https://via.placeholder.com/150x150?text=菜品图片'">
                </div>
                <div class="dish-info">
                    <h3 class="dish-name">${dish.name}</h3>
                    <p class="dish-description">${dish.description || '暂无描述'}</p>
                    <div class="dish-price">¥${dish.price}</div>
                    <button class="add-to-cart-btn" onclick="addToCart('${dish.id}')">
                        加入购物车
                    </button>
                </div>
            `;
            
            return card;
        }
        
        // 添加到购物车
        function addToCart(dishId) {
            const dish = dishes.find(d => d.id === dishId);
            if (dish) {
                window.kuaidiandianService.addToCart(dish);
                updateCartUI();
                
                // 显示添加成功提示
                showToast('已添加到购物车');
            }
        }
        
        // 更新购物车UI
        function updateCartUI() {
            const cartCount = window.kuaidiandianService.getCartCount();
            document.getElementById('cartCount').textContent = cartCount;
            document.getElementById('itemCount').textContent = cartCount;
            
            const checkoutBtn = document.getElementById('checkoutBtn');
            if (cartCount > 0) {
                checkoutBtn.disabled = false;
            } else {
                checkoutBtn.disabled = true;
            }
        }
        
        // 前往购物车
        function goToCart() {
            window.location.href = 'cart.html';
        }
        
        // 显示错误信息
        function showError(message) {
            const dishesSection = document.getElementById('dishesSection');
            dishesSection.innerHTML = `<div class="error">${message}</div>`;
        }
        
        // 显示提示信息
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 2000);
        }
        
        // 初始化服务
        window.kuaidiandianService = new KuaidiandianService();
    </script>
</body>
</html>